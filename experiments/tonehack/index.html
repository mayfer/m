<!DOCTYPE html>
<html>
    <head>
        <title>Tonehack</title>
        <meta charset='utf-8' />
        <script type='text/javascript' src='jquery.min.js'></script>
        <link href="icons/css/font-awesome.css" rel="stylesheet" type="text/css" />
        <script type='text/javascript'>
function gcd(text1,text2){
var gcd=1;
if (text1>text2) {text1=text1+text2; text2=text1-text2; text1=text1-text2;}
if ((text2==(Math.round(text2/text1))*text1)) {gcd=text1}else {
for (var i = Math.round(text1/2) ; i > 1; i=i-1) {
if ((text1==(Math.round(text1/i))*i))
if ((text2==(Math.round(text2/i))*i)) {gcd=i; i=-1;}
}
}
return gcd;
}

function lcm(t1,t2){
var cm=1;
var f=gcd(t1,t2);
cm=t1*t2/f;
return cm;
}

            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame || 
                  window.webkitRequestAnimationFrame || 
                  window.mozRequestAnimationFrame || 
                  window.oRequestAnimationFrame || 
                  window.msRequestAnimationFrame || 
                  function(callback, element){
                      window.setTimeout(callback, 1000 / 60);
                };
            })();

            debug = false;
            start_time = new Date().getTime();
            
            function standingWave(context, index, freq, amplitude) {
                var amplitude = amplitude;
                var step = 0.0;
                var standing = Math.PI / context.width; // resonant wavelength for canvas width
                var freq = freq;
                var freq_diff = freq * standing / 440; // calculate relative wavelength
                var speed = 3;
                var position = index * (context.height / (wavelengths.length+1));
                this.changeSpeed = function(change) {
                    if(change > 0) {
                        speed *= 2;
                    } else {
                        speed /= 2;
                    }
                };
                this.draw = function(time_diff) {
                    if(time_diff == undefined) {
                        time_diff = new Date().getTime() - start_time;
                    }
                    step = speed * time_diff * (Math.PI/20) * freq * (standing / 440) % Math.PI*2;
                    current_amplitude = Math.sin(step) * amplitude;
                    if(debug) {
                        context.fillStyle = "rgba(30, 30, 30, 0.3)";
                    } else {
                        context.fillStyle = "rgba(0, 0, 0, 0.5)";
                    }
                    context.fillRect(0, position-amplitude-10, context.width, amplitude*2+20);

                    context.lineWidth = 4;
                    context.strokeStyle = "#fff";
                
                    var x = 0, y = this.sin(x, freq_diff, current_amplitude);
                    while(x < context.width) {
                        context.beginPath();
                        context.moveTo(x, y + position);
                        x += 4;
                        y = this.sin(x, freq_diff, current_amplitude);
                        context.lineTo(x, y + position);
                        context.stroke();
                    }
                };
                this.reset = function() {
                    context.fillStyle = "rgba(0, 0, 0, 1)";
                    context.fillRect(0, position-amplitude-10, context.width, amplitude*2+20);
                    speed = 3;
                    time_diff = 0;
                    this.draw(time_diff);
                }
                this.sin = function(x, rad_diff, amplitude) {
                    return -amplitude * Math.sin(rad_diff * x);
                };
            }
                    
        
            $(document).ready(function(){
                var canvas_jq = $('<canvas>');
                $('#canvas-container').append(canvas_jq);
                canvas = canvas_jq.get(0);
                canvas.height = canvas_jq.innerWidth();
                canvas.width = canvas_jq.innerHeight();
                context = canvas.getContext("2d");
                // just to be able to access directly from context object
                context.width = canvas.width;
                context.height = canvas.height;

                wavelengths = [440, 440*2, 440*3];

                var waves = [];
                for(i = 0; i < wavelengths.length; i++) {
                    var amplitude = (context.height / wavelengths.length) / 3;
                    waves.push(new standingWave(context, i+1, wavelengths[i], amplitude));
                }

                function drawFrame() {
                    for(i = 0; i < waves.length; i++) {
                        waves[i].draw();
                    }
                }
                function animLoop() {
                    if(state == 'running') {
                        requestAnimFrame(animLoop);
                        drawFrame();
                    }
                }
                drawFrame();

                var pause_time_diff;
                $('.start, .pause, .stop').click(function(e){
                    e.preventDefault();
                    if($(this).hasClass('start')) {
                        if(state != 'running') {
                            if(state == 'stopped') {
                                start_time = new Date().getTime();
                            } else if(state == 'paused') {
                                start_time = new Date().getTime() - pause_time_diff;
                            }
                            state = 'running';
                            animLoop();
                        }
                        $(this).removeClass('start')
                            .removeClass('icon-play')
                            .addClass('pause')
                            .addClass('icon-pause');
                    } else if($(this).hasClass('pause')) {
                        state = 'paused';
                        pause_time_diff = new Date().getTime() - start_time;
                        $(this).removeClass('pause')
                            .removeClass('icon-pause')
                            .addClass('start')
                            .addClass('icon-play');
                    } else if($(this).hasClass('stop')) {
                        state = 'stopped';
                        for(i = 0; i < waves.length; i++) {
                            waves[i].reset();
                        }
                        $('.pause').removeClass('pause')
                            .removeClass('icon-pause')
                            .addClass('start')
                            .addClass('icon-play');
                    }
                });
                $('.stop').click(function(e){
                    e.preventDefault();
                    state = 'stopped';
                });
                $('.faster, .slower').click(function(e){
                    e.preventDefault();
                    var diff = 0;
                    if($(this).hasClass('faster')) diff = 1;
                    else diff = -1;
                    
                    for(i = 0; i < waves.length; i++) {
                        waves[i].changeSpeed(diff);
                    }
                    start_time = new Date().getTime();
                });
            });

            state = 'stopped';

        </script>
        <style type='text/css'>
        
            html, body { margin: 0; padding: 0; background: #000; color: #fff; font-family: Georgia; }
            a { color: #fff; border-bottom: 3px solid #fff; display: inline-block; text-decoration: none;}
            #canvas-container { width: 1028px; margin: 50px auto;  }
            #canvas-container canvas { display: block; width: 1024px; height: 480px; margin: 0 auto; border: 2px solid #fff; }
            
        </style>
    </head>
    <body>
        <div id='canvas-container'>
            <div class='controls'>
                <a href='#' class='start icon-play'></a> /
                <a href='#' class='stop icon-stop'></a> /
                <a href='#' class='faster'>faster</a> /
                <a href='#' class='slower'>slower</a> 
            </div>
        </div>
    </body>
</html>
