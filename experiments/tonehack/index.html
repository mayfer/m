<!DOCTYPE html>
<html>
    <head>
        <title>Tonehack</title>
        <meta charset='utf-8' />
        <script type='text/javascript' src='jquery.min.js'></script>
        <link href="icons/css/font-awesome.css" rel="stylesheet" type="text/css" />
        <script type='text/javascript'>

            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame || 
                  window.webkitRequestAnimationFrame || 
                  window.mozRequestAnimationFrame || 
                  window.oRequestAnimationFrame || 
                  window.msRequestAnimationFrame || 
                  function(callback, element){
                      window.setTimeout(callback, 1000 / 60);
                };
            })();

            var X_INCREMENT = 4;
            var DEFAULT_SPEED = 3;

            function standingWave(context, index, num_waves, freq, amplitude) {
                var amplitude = amplitude;
                var step = 0.0;
                var standing = Math.PI / context.width; // resonant wavelength for canvas width
                var freq = freq;
                var freq_diff = freq * standing / 440; // calculate relative wavelength
                var speed = DEFAULT_SPEED;
                var wave_height = (context.height / (num_waves+1));
                var current_amplitude = 0;
                var current_plot_coordinates = null;
                var position = index * wave_height;// - (wave_height/2);

                this.changeSpeed = function(change) {
                    if(change > 0) {
                        speed *= 2;
                    } else {
                        speed /= 2;
                    }
                };
                this.sin = function(x, rad_diff, amplitude) {
                    return -amplitude * Math.sin(rad_diff * x);
                };
                this.getPlotCoordinates = function(time_diff) {
                    step = speed * time_diff * (Math.PI/20) * freq * (standing / 440) % Math.PI*2;
                    current_amplitude = Math.sin(step) * amplitude;
                    var x = 0, y = this.sin(x, freq_diff, current_amplitude);
                    var points = [];
                    while(x < context.width) {
                        var from = {
                            x: x,
                            y: y,
                        };
                        x += X_INCREMENT;
                        y = this.sin(x, freq_diff, current_amplitude);
                        var to = {
                            x: x,
                            y: y,
                        };
                        points.push({from: from, to: to});
                    }
                    return points;
                };
                this.draw = function(time_diff) {
                    context.fillRect(0, position-amplitude-10, context.width, amplitude*2+20);
                    this.current_plot_coordinates = this.getPlotCoordinates(time_diff);
                    for(var i = 0; i < this.current_plot_coordinates.length; i++) {
                        coord = this.current_plot_coordinates[i];
                        context.beginPath();
                        context.moveTo(coord.from.x, coord.from.y + position);
                        context.lineTo(coord.to.x, coord.to.y + position);
                        context.stroke();
                    }
                };
            }
                    
            function superposedWave(context, index, num_waves, standing_waves) {
                var wave_height = (context.height / (num_waves+1));
                var position = index * wave_height;
                this.draw = function(time_diff) {
                    var superposed_coordinates = [];
                    var num_steps = Math.round(context.width / X_INCREMENT)
                    for(var i = 0; i < num_steps; i++) {
                        var coords = {from: {x: 0, y: 0}, to: {x: 0, y: 0}};
                        for(var j = 0; j < standing_waves.length; j++) {
                            var current_coords;
                            if(standing_waves[j].current_plot_coordinates == null) {
                                current_coords = standing_waves[j].getPlotCoordinates(time_diff);
                            } else {
                                current_coords = standing_waves[j].current_plot_coordinates;
                            }
                            // x is same for all anyways
                            coords.from.x = current_coords[i].from.x;
                            coords.from.y += current_coords[i].from.y;
                            coords.to.x = current_coords[i].to.x;
                            coords.to.y += current_coords[i].to.y;
                        }
                        superposed_coordinates.push(coords);
                    }
                    context.fillRect(0, 0, context.width, context.height);
                    for(var i = 0; i < superposed_coordinates.length; i++) {
                        var coord = superposed_coordinates[i];
                        context.beginPath();
                        context.moveTo(coord.from.x, coord.from.y + position);
                        context.lineTo(coord.to.x, coord.to.y + position);
                        context.stroke();
                    }
                };
            }


            function waveCanvas(jq_elem) {
                var jq_elem = jq_elem;
                var wavelengths = [];
                var overtones = [];
                var waves = [];
                var start_time = new Date().getTime();
                var time_diff = 0;
                var pause_time_diff = 0;
                var state = 'stopped';
                var context;

                this.init = function() {
                    var canvas_jq = $('<canvas>');
                    $(jq_elem).append(canvas_jq);
                    var canvas = canvas_jq.get(0);
                    canvas.height = canvas_jq.innerWidth();
                    canvas.width = canvas_jq.innerHeight();
                    context = canvas.getContext("2d");
                    // just to be able to access directly from context object
                    context.width = canvas.width;
                    context.height = canvas.height;
                    this.makeControls();
                    
                    this.drawWaveMode();
                
                    wavelengths = [440, 440*2, 440*3, 440*4];

                    overtones = [];
                    for(i = 0; i < wavelengths.length; i++) {
                        var amplitude = (context.height / wavelengths.length) / 3;
                        amplitude = amplitude / (i+1);
                        overtones.push(new standingWave(context, i+1, wavelengths.length, wavelengths[i], amplitude));
                    }
                    waves = [];
                    waves.push(new superposedWave(context, 1, 1, overtones));

                    this.drawFrame();

                };

                this.drawWaveMode = function() {
                    context.fillStyle = "rgba(0, 0, 0, 0.5)";
                    context.lineWidth = 4;
                    context.strokeStyle = "#fff";
                };

                this.drawFrame = function() {
                    for(i = 0; i < waves.length; i++) {
                        waves[i].draw(time_diff);
                    }
                    time_diff = new Date().getTime() - start_time;
                }

                this.animLoop = function() {
                    if(state == 'running') {
                        requestAnimFrame(this.animLoop.bind(this));
                        this.drawFrame();
                    }
                }

                this.start = function() {
                    if(state != 'running') {
                        if(state == 'stopped') {
                            start_time = new Date().getTime();
                        } else if(state == 'paused') {
                            start_time = new Date().getTime() - pause_time_diff;
                        }
                        state = 'running';
                        this.animLoop();
                    }
                };

                this.pause = function() {
                    state = 'paused';
                    pause_time_diff = new Date().getTime() - start_time;
                };

                this.stop = function() {
                    state = 'stopped';
                    this.reset()
                };

                this.restart = function() {
                    // graceful
                    start_time = new Date().getTime();
                }

                this.reset = function() {
                    context.fillStyle = "rgba(0, 0, 0, 1)";
                    context.fillRect(0, 0, context.width, context.height);
                    time_diff = 0;
                    this.drawFrame();
                };

                this.makeControls = function(){
                    var wave_canvas = this;
                    var controls = $('<div>').addClass('controls');
                    $.each([
                        $('<a>').addClass('start icon-play'),
                        $('<a>').addClass('stop icon-stop'),
                        $('<a>').addClass('faster').html('faster'),
                        $('<a>').addClass('slower').html('slower'),
                        $('<a>').addClass('superpose tab').html('superpose'),
                        $('<a>').addClass('split tab selected').html('split'),
                    ], function() {
                        $(this).attr('href', '#');
                        $(this).appendTo(controls);
                    });
                    controls.prependTo(jq_elem);

                    controls.on('click', '.start, .pause, .stop', function(e){
                        e.preventDefault();
                        if($(this).hasClass('start')) {
                            wave_canvas.start();
                            $(this).removeClass('start')
                                .removeClass('icon-play')
                                .addClass('pause')
                                .addClass('icon-pause');
                        } else if($(this).hasClass('pause')) {
                            wave_canvas.pause();
                            $(this).removeClass('pause')
                                .removeClass('icon-pause')
                                .addClass('start')
                                .addClass('icon-play');
                        } else if($(this).hasClass('stop')) {
                            wave_canvas.stop();
                            $('.pause').removeClass('pause')
                                .removeClass('icon-pause')
                                .addClass('start')
                                .addClass('icon-play');
                        }
                    });
                    controls.on('click', '.stop', function(e){
                        e.preventDefault();
                        state = 'stopped';
                    });
                    controls.on('click', '.faster, .slower', function(e){
                        e.preventDefault();
                        var diff = 0;
                        if($(this).hasClass('faster')) diff = 1;
                        else diff = -1;
                    
                        for(i = 0; i < overtones.length; i++) {
                            overtones[i].changeSpeed(diff);
                        }
                        wave_canvas.restart();
                    });
                };
            }
        
            $(document).ready(function(){
                var wave_canvas = new waveCanvas($('#canvas-container'));
                wave_canvas.init();
            });


        </script>
        <style type='text/css'>
        
            html, body { margin: 0; padding: 0; background: #000; color: #fff; font-family: courier, courier new, monaco, monospace;; }
            .container { width: 1028px; margin: 0 auto;  }
            canvas { display: block; width: 1024px; height: 480px; margin: 0 auto; border: 2px solid #fff; }
            
            a { color: #fff; border-bottom: 3px solid #fff; display: inline-block; text-decoration: none;}
            .controls a { display: inline-block; min-width: 15px; text-align: center; margin-right: 10px; margin-bottom: 0px; padding: 3px 5px; }
            .controls a.tab { float: right; margin-right: 20px;  background: #000; position: relative; z-index: 1000; border: 2px solid #888; border-bottom: none; margin-bottom: -3px; padding: 3px 10px; color: #999; }
            .controls a.tab.selected { float: right; margin-right: 20px;  background: #000; position: relative; z-index: 1000; border: 2px solid #fff; border-bottom: 3px solid #000; margin-bottom: -3px; padding: 3px 10px; color: #fff; }

            h1, h2 { padding: 0; margin: 40px 0; font-weight: normal; text-align: center; text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff, 0 0 40px #00ffde, 0 0 70px #00ffde, 0 0 80px #00ffde, 0 0 100px #00ffde, 0 0 150px #00ffde; color: #fff; }
            h1 { font-size: 25px; line-height: 28px; text-align: right; }
            h2 { font-size: 16px; line-height: 20px; margin-bottom: 40px; text-align: right; }
            h2 span { font-size: 25px; }
        </style>
    </head>
    <body>
        <div class='container'>
            <h1>tonehack<span> &lt;</span></h1>
            <div id='canvas-container'>
            </div>
        </div>
    </body>
</html>
